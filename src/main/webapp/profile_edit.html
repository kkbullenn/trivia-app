<!--
   Profile Edit Page
   Allows editing username and avatar URL.

   Author: Jerry Xing
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <title>Edit Profile</title>
</head>
<body class="bg-blue-900 text-yellow-300 min-h-screen">
<div class="flex min-h-screen flex-col">
  <header class="flex items-center justify-between bg-blue-950/90 px-4 py-3 shadow">
    <button id="backButton" class="text-yellow-300 transition hover:text-yellow-100" aria-label="Back to profile">
      <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
           stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <h1 class="text-lg font-semibold uppercase tracking-wide">Edit Profile</h1>
    <button id="logoutButton" class="text-yellow-300 transition hover:text-yellow-100" aria-label="Logout">
      <svg class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
           stroke-linejoin="round">
        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
        <polyline points="10 17 15 12 10 7"/>
        <line x1="15" y1="12" x2="3" y2="12"/>
      </svg>
    </button>
  </header>

  <main class="mx-auto flex w-full max-w-xl flex-1 flex-col gap-8 px-6 py-12">
    <section class="flex flex-col items-center gap-4 text-center">
      <div class="h-32 w-32 overflow-hidden rounded-full border-4 border-yellow-400/80 bg-blue-950">
        <img id="previewAvatar" src="" alt="Preview Avatar" class="h-full w-full object-cover"/>
      </div>
      <h2 id="previewName" class="text-2xl font-bold text-yellow-100">PLAYER</h2>
    </section>

    <section class="flex flex-col gap-6 rounded-xl border border-yellow-400/40 bg-blue-950/80 p-6 shadow-lg">
      <label class="flex flex-col gap-2 text-left">
        <span class="text-sm font-semibold uppercase tracking-wide text-yellow-200">Username</span>
        <input id="usernameInput" type="text" class="rounded-lg border border-yellow-300/40 bg-blue-900 px-4 py-3 text-yellow-100 focus:border-yellow-300 focus:outline-none" placeholder="Enter username"/>
      </label>
      <label class="flex flex-col gap-2 text-left">
        <span class="text-sm font-semibold uppercase tracking-wide text-yellow-200">Avatar URL</span>
        <input id="avatarInput" type="url" class="rounded-lg border border-yellow-300/40 bg-blue-900 px-4 py-3 text-yellow-100 focus:border-yellow-300 focus:outline-none" placeholder="https://example.com/avatar.png"/>
        <span class="block text-xs text-yellow-200/70">Provide a direct image link (http/https). Leave blank to use default identicon.</span>
      </label>
      <div class="flex flex-col gap-3 rounded-lg border border-dashed border-yellow-300/40 bg-blue-900/60 p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="flex flex-col">
            <span class="text-sm font-semibold uppercase tracking-wide text-yellow-200">Upload Avatar</span>
            <span class="text-xs text-yellow-200/70">Supports PNG, JPG, GIF, WEBP under 2MB.</span>
          </div>
          <button id="uploadTrigger" type="button" class="rounded-lg border border-yellow-300/40 bg-blue-900 px-4 py-2 text-sm font-semibold text-yellow-100 transition hover:bg-blue-800">Choose File</button>
        </div>
        <input id="avatarFileInput" type="file" accept="image/*" capture="environment" class="hidden"/>
      </div>
      <div id="statusMessage" class="hidden rounded-lg border border-yellow-300/30 bg-blue-900/70 px-4 py-2 text-sm"></div>
      <button id="saveButton" class="rounded-lg bg-yellow-400 px-6 py-3 text-lg font-semibold text-blue-950 transition hover:bg-yellow-300">
        Save Changes
      </button>
    </section>
  </main>
</div>

<script>
  (function () {
    const usernameInput = document.getElementById('usernameInput');
    const avatarInput = document.getElementById('avatarInput');
    const previewAvatar = document.getElementById('previewAvatar');
    const previewName = document.getElementById('previewName');
    const statusMessage = document.getElementById('statusMessage');
    const saveButton = document.getElementById('saveButton');
    const backButton = document.getElementById('backButton');
    const logoutButton = document.getElementById('logoutButton');
    const uploadTrigger = document.getElementById('uploadTrigger');
    const avatarFileInput = document.getElementById('avatarFileInput');
    let tempObjectUrl = null;
    let uploadedAvatarUrl = '';

    const getContextPath = () => {
      const path = window.location.pathname;
      const parts = path.split('/');
      parts.pop();
      const joined = parts.join('/');
      return joined.length ? joined : '';
    };

    const goTo = (path) => {
      const base = getContextPath();
      window.location.href = `${base}${path}`;
    };

    const normalizeMessage = (value) => {
      if (value && typeof value === 'object') {
        if (typeof value.message === 'string') {
          return value.message;
        }
        return JSON.stringify(value);
      }

      if (typeof value === 'string') {
        const trimmed = value.trim();
        if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
          try {
            const parsed = JSON.parse(trimmed);
            if (parsed && typeof parsed.message === 'string') {
              return parsed.message;
            }
          } catch (_) {
            // ignore JSON parse errors and fall through
          }
        }
        return trimmed;
      }

      return '';
    };

    const showStatus = (message, tone = 'info') => {
      if (!statusMessage) return;
      const normalized = normalizeMessage(message);
      if (!normalized) {
        statusMessage.classList.add('hidden');
        statusMessage.textContent = '';
        return;
      }
      statusMessage.textContent = normalized;
      statusMessage.classList.remove('hidden');
      const toneClass = tone === 'success'
        ? 'border-green-400 bg-green-900/50 text-green-200'
        : tone === 'error'
          ? 'border-red-400 bg-red-900/50 text-red-200'
          : 'border-yellow-300/30 bg-blue-900/70 text-yellow-100';
      statusMessage.className = `rounded-lg px-4 py-2 text-sm ${toneClass}`;
    };

    const setPreviewSrc = (src) => {
      if (tempObjectUrl && tempObjectUrl !== src) {
        URL.revokeObjectURL(tempObjectUrl);
        tempObjectUrl = null;
      }
      previewAvatar.src = src;
    };

    const toIdenticon = (name) => {
      const seed = name && name.trim() ? name.trim() : 'player';
      return `https://github.com/identicons/${encodeURIComponent(seed)}.png`;
    };

    const updatePreview = () => {
      const name = usernameInput.value.trim() || 'Player';
      const avatarUrl = avatarInput.value.trim();
      previewName.textContent = name.toUpperCase();
      const source = avatarUrl || uploadedAvatarUrl || toIdenticon(name);
      setPreviewSrc(source);
    };

    usernameInput.addEventListener('input', updatePreview);
    avatarInput.addEventListener('input', () => {
      uploadedAvatarUrl = '';
      updatePreview();
    });

    backButton.addEventListener('click', () => goTo('/USER'));

    logoutButton.addEventListener('click', async () => {
      try {
        await fetch(`${getContextPath()}/EXIT`, { method: 'POST', credentials: 'same-origin' });
      } catch (err) {
        console.error('Failed to log out', err);
      } finally {
        goTo('/login');
      }
    });

    async function loadProfile() {
      try {
        const res = await fetch(`${getContextPath()}/user/profile`, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          credentials: 'same-origin'
        });
        if (res.status === 401) {
          goTo('/login');
          return;
        }
        if (!res.ok) {
          throw new Error(`Failed to load profile: ${res.status}`);
        }
        const data = await res.json();
        const username = data.username || 'Player';
        const avatarUrl = data.avatar_url || '';

        usernameInput.value = username;

        if (!avatarUrl || data.using_default) {
          uploadedAvatarUrl = '';
          avatarInput.value = '';
        } else if (avatarUrl.startsWith('http://') || avatarUrl.startsWith('https://')) {
          uploadedAvatarUrl = '';
          avatarInput.value = avatarUrl;
        } else {
          uploadedAvatarUrl = avatarUrl;
          avatarInput.value = '';
        }

        updatePreview();
      } catch (err) {
        console.error(err);
        showStatus('Failed to load profile. Please refresh.', 'error');
      }
    }

    uploadTrigger.addEventListener('click', () => {
      avatarFileInput.click();
    });

    avatarFileInput.addEventListener('change', async () => {
      const [file] = avatarFileInput.files;
      if (!file) {
        return;
      }
      if (!file.type || !file.type.startsWith('image/')) {
        showStatus('Please select a valid image file.', 'error');
        avatarFileInput.value = '';
        return;
      }
      if (file.size > 2 * 1024 * 1024) {
        showStatus('Image must be smaller than 2MB.', 'error');
        avatarFileInput.value = '';
        return;
      }

      if (tempObjectUrl) {
        URL.revokeObjectURL(tempObjectUrl);
      }
      tempObjectUrl = URL.createObjectURL(file);
      previewAvatar.src = tempObjectUrl;
      previewName.textContent = (usernameInput.value.trim() || 'Player').toUpperCase();

      await uploadAvatarFile(file);
    });

    async function uploadAvatarFile(file) {
      const formData = new FormData();
      formData.append('avatar', file);
      try {
        showStatus('Uploading avatar...', 'info');
        const res = await fetch(`${getContextPath()}/user/avatar/upload`, {
          method: 'POST',
          body: formData,
          credentials: 'same-origin'
        });
        if (res.status === 401) {
          goTo('/login');
          return;
        }
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `Upload failed: ${res.status}`);
        }
        const data = await res.json();
        uploadedAvatarUrl = data.avatar_url || '';
        avatarInput.value = '';
        if (tempObjectUrl) {
          URL.revokeObjectURL(tempObjectUrl);
          tempObjectUrl = null;
        }
        showStatus('Avatar uploaded successfully.', 'success');
        updatePreview();
      } catch (err) {
        console.error(err);
        showStatus(err.message || 'Failed to upload avatar.', 'error');
        if (tempObjectUrl) {
          URL.revokeObjectURL(tempObjectUrl);
          tempObjectUrl = null;
        }
        updatePreview();
      } finally {
        avatarFileInput.value = '';
      }
    }

    async function saveProfile() {
      const urlValue = avatarInput.value.trim();
      const payload = {
        username: usernameInput.value.trim(),
        avatar_url: urlValue || uploadedAvatarUrl || ''
      };

      try {
        saveButton.disabled = true;
        showStatus('Saving...', 'info');
        const res = await fetch(`${getContextPath()}/user/profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify(payload)
        });
        if (res.status === 401) {
          goTo('/login');
          return;
        }
        if (res.status === 409) {
          let errMsg = 'Username is already taken. Please choose another one.';
          try {
            const data = await res.json();
            if (data && data.message) {
              errMsg = data.message;
            }
          } catch (_) {}
          showStatus(errMsg, 'error');
          return;
        }
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || `Failed to save profile: ${res.status}`);
        }
        const data = await res.json();
        showStatus('Profile updated successfully.', 'success');
        usernameInput.value = data.username || payload.username || 'Player';

        const savedAvatarUrl = data.avatar_url || '';
        if (!savedAvatarUrl || data.using_default) {
          uploadedAvatarUrl = '';
          avatarInput.value = '';
        } else if (savedAvatarUrl.startsWith('http://') || savedAvatarUrl.startsWith('https://')) {
          uploadedAvatarUrl = '';
          avatarInput.value = savedAvatarUrl;
        } else {
          uploadedAvatarUrl = savedAvatarUrl;
          avatarInput.value = '';
        }
        updatePreview();
      } catch (err) {
        console.error(err);
        showStatus(err.message || 'Failed to save profile.', 'error');
      } finally {
        saveButton.disabled = false;
      }
    }

    saveButton.addEventListener('click', () => {
      saveProfile();
    });

    loadProfile();
  })();
</script>
</body>
</html>
